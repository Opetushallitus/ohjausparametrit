<?xml version="1.0" encoding="UTF-8"?> 
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" 
             xmlns:activiti="http://activiti.org/bpmn"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             targetNamespace="OPH">
     
    <process id="tarjontaHakuPublication">

        <startEvent id="start" />
        
        <sequenceFlow id="flow1" sourceRef="start" targetRef="scriptInfo" />

        <scriptTask id="scriptInfo" scriptFormat="groovy">
            <script>
                System.out.println("Schedule HAKU PUBLICATION");
                System.out.println(" now = " + new Date());
                System.out.println(" target = ${target} (== haku)");
                System.out.println(" type = ${type}");
                System.out.println(" date = ${date} (== when to run)");
                // System.out.println(" process_start_time = ${process_start_time}");
            </script>
        </scriptTask>

        <sequenceFlow id="flow2" sourceRef="scriptInfo" targetRef="longTimerTask" />
        
        <userTask id="longTimerTask" name="Task with timer on it">
          <documentation>This task has a timer on it</documentation>
        </userTask>
        <boundaryEvent id="longTimer" cancelActivity="true" attachedToRef="longTimerTask">
          <timerEventDefinition>
<!--              <timeDate>${process_start_time}</timeDate> -->
              <timeDate>${date}</timeDate>
          </timerEventDefinition>
        </boundaryEvent>
                
        <sequenceFlow id="flow3_0" sourceRef="longTimerTask" targetRef="scriptInfoEnd" />
        <sequenceFlow id="flow3_1" sourceRef="longTimer" targetRef="scriptInfoEnd" />

        <scriptTask id="scriptInfoEnd" scriptFormat="groovy">
            <script>
                // The time has arrived to publish
                System.out.println("Publishing haku oid: ${target} ...");
                try {
                    if (tarjontaHakuPublicationBean.publish("${target}")) {
                      System.out.println("  Haku publish SUCCESS");
                    } else {
                      System.out.println("  Haku publish FAILED...");
                      tarjontaHakuPublicationBean.sendErrorEmail("${target}", null);
                    }
                } catch (Exception ex) {
                      System.out.println("  Haku publish FAILED with exception..." + ex);
                      tarjontaHakuPublicationBean.sendErrorEmail("${target}", ex);
                }

                System.out.println("ENDING process at: " + new Date());
            </script>
        </scriptTask>
                        
        <sequenceFlow id="flow4" sourceRef="scriptInfoEnd" targetRef="theEnd" />
                
        <endEvent id="theEnd" />

        
<!--

        FIRST WORKING TIMER

        <startEvent id="start" />
        
        <sequenceFlow id="flow1" sourceRef="start" targetRef="scriptInfo" />

        <scriptTask id="scriptInfo" scriptFormat="groovy">
            <script>
                System.out.println("Starting process at: " + new Date());
                System.out.println(" id = ${id}");
                System.out.println(" date = ${date}");
            </script>
        </scriptTask>

        <sequenceFlow id="flow2" sourceRef="scriptInfo" targetRef="longTimerTask" />
        
        <userTask id="longTimerTask" name="Task with timer on it">
          <documentation>This task has a timer on it</documentation>
        </userTask>
        <boundaryEvent id="longTimer" cancelActivity="true" attachedToRef="longTimerTask">
          <timerEventDefinition>
            <timeDuration>PT1M</timeDuration>
          </timerEventDefinition>
        </boundaryEvent>
                
        <sequenceFlow id="flow3_0" sourceRef="longTimerTask" targetRef="scriptInfoEnd" />
        <sequenceFlow id="flow3_1" sourceRef="longTimer" targetRef="scriptInfoEnd" />

        <scriptTask id="scriptInfoEnd" scriptFormat="groovy">
            <script>
                System.out.println("Ending process at: " + new Date());
                System.out.println(" id = ${id}");
                System.out.println(" date = ${date}");
            </script>
        </scriptTask>
                        
        <sequenceFlow id="flow4" sourceRef="scriptInfoEnd" targetRef="theEnd" />
                
        <endEvent id="theEnd" />
-->        
                                                        
    </process>
 
</definitions>
