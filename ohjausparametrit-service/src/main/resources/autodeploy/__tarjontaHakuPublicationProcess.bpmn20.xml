<?xml version="1.0" encoding="UTF-8"?> 
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" 
             xmlns:activiti="http://activiti.org/bpmn"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             targetNamespace="OPH">
     
    <process id="tarjontaHakuPublication">

        <startEvent id="start" />
        
        <sequenceFlow id="flow1" sourceRef="start" targetRef="scriptInfo" />

        <scriptTask id="scriptInfo" scriptFormat="groovy">
            <script>
                myLogger.info("Schedule HAKU PUBLICATION");
                myLogger.info(" now = " + new Date());
                myLogger.info(" target = ${target} (== haku)");
                myLogger.info(" type = ${type}");
                myLogger.info(" date = ${date} (== when to run)");
            </script>
        </scriptTask>

        <sequenceFlow id="flow2" sourceRef="scriptInfo" targetRef="longTimerTask" />
        
        <userTask id="longTimerTask" name="Task with timer on it">
          <documentation>This 'user' task has a timer on it</documentation>
        </userTask>
        <boundaryEvent id="longTimer" cancelActivity="true" attachedToRef="longTimerTask">
          <timerEventDefinition>
              <timeDate>${date}</timeDate>
          </timerEventDefinition>
        </boundaryEvent>
                
        <sequenceFlow id="flow3_0" sourceRef="longTimerTask" targetRef="scriptInfoEnd" />
        <sequenceFlow id="flow3_1" sourceRef="longTimer" targetRef="scriptInfoEnd" />

        <scriptTask id="scriptInfoEnd" scriptFormat="groovy">
            <script>
                // The time has arrived to publish
                myLogger.info("Publishing haku oid: ${target} ...");
                try {
                    if (tarjontaHakuPublicationBean.publish("${target}")) {
                      myLogger.info("Publishing haku oid: ${target} ... SUCCESS");
                    } else {
                      myLogger.error("Publishing haku oid: ${target} ... FAILED");
                    }
                } catch (Exception ex) {
                      myLogger.error("Publishing haku oid: ${target} ... FAILED", ex);
                }
                myLogger.info("ENDING process at: " + new Date());
            </script>
        </scriptTask>
                        
        <sequenceFlow id="flow4" sourceRef="scriptInfoEnd" targetRef="theEnd" />
                
        <endEvent id="theEnd" />

    </process>
 
</definitions>
